(function(a,h,e){"object"===typeof global&&(global[a]=e);"object"===typeof module&&module.exports&&(module.exports=e);h[a]=e})("ipromise",this,function(a,h){function e(a){return Array.prototype.slice.call(a,0)}function k(a){return"[object Function]"==toString.call(a)}function l(a,c){for(var d,b=0;b<c.length;++b)d=c[b],k(d)?a.push(d):"[object Array]"==toString.call(d)&&l(a,d);return a}function n(a,c,d){c=l([],e(c));for(var b=0;b<c.length;++b)c[b].status=d,a.push(c[b])}function q(a,c){try{if(a===c)throw new TypeError("promise and x are the same object");
if("[object Object]"==toString.call(c)||k(c)){var d=c.then;if(k(d)){var b=!0;try{d.call(c,function(c){b&&(q(a,c),b=!1)},function(c){b&&(a.reject(c),b=!1)})}catch(f){b&&a.reject(f)}}else a.resolve(c)}else a.resolve(c)}catch(e){a.reject(e)}}for(var r in a)a[a[r]]=r;var p;a:{try{p=process.nextTick;break a}catch(s){}p=setImmediate}return function c(){function d(a){p(function(){if(a.promise)try{q(a.promise,a.apply(h,m))}catch(c){a.promise.reject(c)}else a.apply(h,m)})}function b(a,c){for(var b=0;b<a.length;++b)c?
a[b].status&c&&d(a[b]):d(a[b])}if(this.constructor!=c)return new c;var f=a.PENDING,m,g=[];this.done=function(){f==a.PENDING&&n(g,arguments,a.DONE);f==a.RESOLVED&&b(l([],e(arguments)));return this};this.fail=function(){f==a.PENDING&&n(g,arguments,a.FAIL);f==a.REJECTED&&b(l([],e(arguments)));return this};this.then=function(a,b){var d=new c;k(a)||(a=function(){d.resolve.apply(h,arguments)});k(b)||(b=function(){d.reject.apply(h,arguments)});a.promise=b.promise=d;this.done(a).fail(b);return d};this.always=
function(){f==a.PENDING?n(g,arguments,a.DONE|a.FAIL):b(l([],e(arguments)));return this};this.resolve=function(){f==a.PENDING&&(f=a.RESOLVED,m=e(arguments),b(g,a.DONE),delete g);return this};this.reject=function(){f==a.PENDING&&(f=a.REJECTED,m=e(arguments),b(g,a.FAIL),delete g);return this};this.state=function(){return a[f].toLowerCase()};return this}}({PENDING:1,RESOLVED:2,REJECTED:4,DONE:8,FAIL:16}));